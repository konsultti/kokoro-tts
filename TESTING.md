# Testing Plan for Audiobook Front Matter & Intro Features

## Overview
This document outlines a minimal testing strategy for the audiobook front matter skipping and introduction generation features.

## Critical Tests (Minimal Coverage)

### 1. Front Matter Detection Tests

**Test File: `test_front_matter.py`**

```python
"""
Unit tests for front matter detection
"""
import sys
sys.path.insert(0, '.')

from kokoro_tts import is_front_matter

def test_skip_copyright():
    """Should skip copyright pages"""
    assert is_front_matter("Copyright", order=1) == True
    assert is_front_matter("Copyright © 2024", order=1) == True
    assert is_front_matter("Legal Notice", order=1) == True

def test_skip_toc():
    """Should skip table of contents"""
    assert is_front_matter("Table of Contents", order=1) == True
    assert is_front_matter("Contents", order=1) == True
    assert is_front_matter("TOC", order=1) == True

def test_skip_acknowledgments():
    """Should skip acknowledgments and dedication"""
    assert is_front_matter("Acknowledgments", order=2) == True
    assert is_front_matter("Dedication", order=2) == True
    assert is_front_matter("About the Author", order=20) == True

def test_keep_story_content():
    """Should KEEP foreword, preface, introduction, prologue"""
    assert is_front_matter("Foreword", order=1) == False
    assert is_front_matter("Preface", order=2) == False
    assert is_front_matter("Introduction", order=3) == False
    assert is_front_matter("Prologue", order=4) == False

def test_short_early_chapters():
    """Should skip very short early chapters with skip-worthy content"""
    assert is_front_matter("Copy", order=1, word_count=100) == True
    assert is_front_matter("Edition Info", order=2, word_count=200) == True
    # But not if it's substantial
    assert is_front_matter("Copy", order=1, word_count=1000) == False

def test_regular_chapters():
    """Should not skip regular chapters"""
    assert is_front_matter("Chapter 1", order=5) == False
    assert is_front_matter("The Beginning", order=10) == False
    assert is_front_matter("Part One", order=1) == False

if __name__ == "__main__":
    # Run tests manually
    print("Testing front matter detection...")
    test_skip_copyright()
    print("✓ Copyright detection works")
    test_skip_toc()
    print("✓ TOC detection works")
    test_skip_acknowledgments()
    print("✓ Acknowledgments detection works")
    test_keep_story_content()
    print("✓ Story content preservation works")
    test_short_early_chapters()
    print("✓ Short chapter heuristics work")
    test_regular_chapters()
    print("✓ Regular chapters not skipped")
    print("\n✅ All front matter tests passed!")
```

**Run:**
```bash
# With virtual environment activated
python test_front_matter.py

# Or with uv
uv run python test_front_matter.py
```

---

### 2. Introduction Generation Tests

**Test File: `test_intro_generation.py`**

```python
"""
Unit tests for audiobook introduction generation
"""
import sys
sys.path.insert(0, '.')

from kokoro_tts import generate_audiobook_intro

def test_full_metadata():
    """Should generate full intro with title and author"""
    metadata = {'title': 'The Great Novel', 'author': 'Jane Doe'}
    intro = generate_audiobook_intro(metadata)
    assert 'The Great Novel' in intro
    assert 'Jane Doe' in intro
    assert 'Kokoro Text-to-Speech' in intro
    print(f"Full intro: {intro}")

def test_title_only():
    """Should generate intro with only title"""
    metadata = {'title': 'Mystery Book', 'author': None}
    intro = generate_audiobook_intro(metadata)
    assert 'Mystery Book' in intro
    assert 'narrated by Kokoro' in intro
    print(f"Title-only intro: {intro}")

def test_author_only():
    """Should generate intro with only author"""
    metadata = {'title': None, 'author': 'John Smith'}
    intro = generate_audiobook_intro(metadata)
    assert 'John Smith' in intro
    assert 'Kokoro Text-to-Speech' in intro
    print(f"Author-only intro: {intro}")

def test_no_metadata():
    """Should generate fallback intro with no metadata"""
    metadata = {'title': None, 'author': None}
    intro = generate_audiobook_intro(metadata)
    assert 'Audiobook generated by Kokoro' in intro or 'Kokoro Text-to-Speech' in intro
    print(f"Fallback intro: {intro}")

if __name__ == "__main__":
    print("Testing introduction generation...")
    test_full_metadata()
    print("✓ Full metadata intro works")
    test_title_only()
    print("✓ Title-only intro works")
    test_author_only()
    print("✓ Author-only intro works")
    test_no_metadata()
    print("✓ Fallback intro works")
    print("\n✅ All intro generation tests passed!")
```

**Run:**
```bash
# With virtual environment activated
python test_intro_generation.py

# Or with uv
uv run python test_intro_generation.py
```

---

### 3. Integration Test with Mock EPUB

**Test File: `test_epub_mock.py`**

```python
"""
Integration test with minimal mock EPUB structure
"""
import sys
sys.path.insert(0, '.')

# Mock test - demonstrates what SHOULD be tested
def test_epub_extraction_with_front_matter():
    """
    This test would require creating a real EPUB file.
    For now, this documents the expected behavior.
    """
    # Expected EPUB structure:
    # 1. Copyright (should be skipped)
    # 2. Table of Contents (should be skipped)
    # 3. Dedication (should be skipped)
    # 4. Foreword (should be KEPT)
    # 5. Prologue (should be KEPT)
    # 6. Chapter 1 (should be KEPT)
    # 7. Acknowledgments (at end, should be skipped)

    expected_kept_chapters = [
        "Foreword",
        "Prologue",
        "Chapter 1"
    ]

    expected_skipped = [
        "Copyright",
        "Table of Contents",
        "Dedication",
        "Acknowledgments"
    ]

    print("Expected behavior documented:")
    print(f"  Keep: {expected_kept_chapters}")
    print(f"  Skip: {expected_skipped}")

    # TODO: Create actual test.epub and verify
    # from kokoro_tts import extract_chapters_from_epub
    # chapters = extract_chapters_from_epub("test.epub", skip_front_matter=True)
    # assert len(chapters) == 3
    # assert chapters[0]['title'] == "Foreword"

if __name__ == "__main__":
    print("Testing EPUB integration (mock)...")
    test_epub_extraction_with_front_matter()
    print("✓ Expected behavior documented")
    print("\n⚠️  Integration test needs real EPUB file to run")
```

---

## Manual Testing Checklist

### Minimal Critical Tests

- [ ] **Test 1: Front matter detection**
  ```bash
  python test_front_matter.py
  ```

- [ ] **Test 2: Intro generation**
  ```bash
  python test_intro_generation.py
  ```

- [ ] **Test 3: End-to-end with real EPUB**
  - Find/create a simple EPUB with:
    - Copyright page
    - TOC
    - Foreword
    - Chapter 1
  - Run:
    ```bash
    kokoro-tts book.epub --audiobook output.m4a --debug
    ```
  - Verify:
    - Copyright and TOC were skipped (check debug output)
    - Foreword was kept
    - Introduction chapter added
    - Audio plays correctly

- [ ] **Test 4: Custom intro text**
  ```bash
  kokoro-tts book.epub --audiobook output.m4a \
    --intro-text "Testing custom intro"
  ```
  - Verify intro uses custom text

- [ ] **Test 5: No intro**
  ```bash
  kokoro-tts book.epub --audiobook output.m4a --no-intro
  ```
  - Verify no intro chapter in output

---

## Mock EPUB Creation

**Script: `create_test_epub.py`**

```python
"""
Create a minimal test EPUB for manual testing
Requires: pip install ebooklib
"""
from ebooklib import epub

def create_test_epub():
    book = epub.EpubBook()

    # Metadata
    book.set_identifier('test123')
    book.set_title('Test Novel')
    book.set_language('en')
    book.add_author('Test Author')

    # Chapter 1: Copyright (should be skipped)
    c1 = epub.EpubHtml(title='Copyright',
                       file_name='copyright.xhtml',
                       lang='en')
    c1.content = '<html><body><h1>Copyright</h1><p>Copyright © 2024 Test Author. All rights reserved.</p></body></html>'

    # Chapter 2: Table of Contents (should be skipped)
    c2 = epub.EpubHtml(title='Table of Contents',
                       file_name='toc.xhtml',
                       lang='en')
    c2.content = '<html><body><h1>Contents</h1><p>Chapter 1... Page 1</p></body></html>'

    # Chapter 3: Dedication (should be skipped)
    c3 = epub.EpubHtml(title='Dedication',
                       file_name='dedication.xhtml',
                       lang='en')
    c3.content = '<html><body><h1>Dedication</h1><p>For my family.</p></body></html>'

    # Chapter 4: Foreword (should be KEPT)
    c4 = epub.EpubHtml(title='Foreword',
                       file_name='foreword.xhtml',
                       lang='en')
    c4.content = '<html><body><h1>Foreword</h1><p>This is an important foreword that sets up the story. It contains context about why this book was written and what readers should expect. This is part of the story experience and should not be skipped.</p></body></html>'

    # Chapter 5: Prologue (should be KEPT)
    c5 = epub.EpubHtml(title='Prologue',
                       file_name='prologue.xhtml',
                       lang='en')
    c5.content = '<html><body><h1>Prologue</h1><p>It was a dark and stormy night. The story begins here with important background that readers need to understand the main narrative.</p></body></html>'

    # Chapter 6: Chapter 1 (should be KEPT)
    c6 = epub.EpubHtml(title='Chapter 1: The Beginning',
                       file_name='chap_01.xhtml',
                       lang='en')
    c6.content = '<html><body><h1>Chapter 1</h1><p>The main story starts here. Our protagonist wakes up and discovers something amazing.</p></body></html>'

    # Add chapters to book
    book.add_item(c1)
    book.add_item(c2)
    book.add_item(c3)
    book.add_item(c4)
    book.add_item(c5)
    book.add_item(c6)

    # Define Table of Contents
    book.toc = (
        epub.Link('copyright.xhtml', 'Copyright', 'copyright'),
        epub.Link('toc.xhtml', 'Table of Contents', 'toc'),
        epub.Link('dedication.xhtml', 'Dedication', 'dedication'),
        epub.Link('foreword.xhtml', 'Foreword', 'foreword'),
        epub.Link('prologue.xhtml', 'Prologue', 'prologue'),
        epub.Link('chap_01.xhtml', 'Chapter 1', 'chap_01')
    )

    # Add navigation files
    book.add_item(epub.EpubNcx())
    book.add_item(epub.EpubNav())

    # Define spine
    book.spine = ['nav', c1, c2, c3, c4, c5, c6]

    # Write EPUB file
    epub.write_epub('test_audiobook.epub', book)
    print("✓ Created test_audiobook.epub")
    print("\nExpected results when processing with --audiobook:")
    print("  SKIP: Copyright, Table of Contents, Dedication")
    print("  KEEP: Foreword, Prologue, Chapter 1")
    print("\nTest command:")
    print("  kokoro-tts test_audiobook.epub --audiobook test.m4a --debug")

if __name__ == "__main__":
    create_test_epub()
```

**Run:**
```bash
pip install ebooklib
python create_test_epub.py
kokoro-tts test_audiobook.epub --audiobook test.m4a --debug
```

---

## Future Test Improvements

### Short-term (Next Sprint)
1. **Add pytest framework**
   - Convert tests to use pytest
   - Add fixtures for mock metadata
   - Add parametrized tests for edge cases

2. **Create test fixtures**
   - Multiple EPUB samples with different structures
   - PDF samples with various TOC formats
   - Edge cases: books without metadata, single-chapter books

3. **Add regression tests**
   - Test that foreword/preface/introduction are NEVER skipped
   - Test chapter ordering after front matter removal
   - Test intro insertion doesn't break chapter numbering

### Medium-term (Future Releases)
1. **Automated CI/CD testing**
   - GitHub Actions workflow
   - Run tests on every commit
   - Test across Python 3.10-3.13

2. **Integration tests**
   - Full audiobook creation pipeline
   - Metadata embedding verification
   - Chapter marker validation
   - Audio file integrity checks

3. **Performance tests**
   - Test with large EPUBs (500+ pages)
   - Memory usage monitoring
   - Processing time benchmarks

### Long-term (Nice to Have)
1. **Fuzzing tests**
   - Malformed EPUB files
   - Unusual chapter structures
   - Non-standard metadata

2. **User acceptance tests**
   - Real-world EPUB samples from different publishers
   - Various fiction/non-fiction formats
   - Multi-language books

3. **Coverage analysis**
   - Aim for 80%+ code coverage
   - Focus on critical paths
   - Edge case documentation

---

## Running All Tests

```bash
# Setup environment first
source .venv/bin/activate  # Or use uv

# Install test dependencies (if using pytest in future)
# pip install pytest pytest-cov

# Run minimal tests
python test_front_matter.py
python test_intro_generation.py

# Create and test with mock EPUB
python create_test_epub.py
kokoro-tts test_audiobook.epub --audiobook test.m4a --debug --voice af_sarah

# Manual verification
# 1. Check debug output for skipped chapters
# 2. Listen to generated audiobook
# 3. Verify intro is present and correct
# 4. Verify foreword/prologue are included
```

---

## Success Criteria

**Minimal tests pass if:**
- ✅ All unit tests in `test_front_matter.py` pass
- ✅ All unit tests in `test_intro_generation.py` pass
- ✅ Manual EPUB test shows:
  - Copyright/TOC/Dedication skipped (in debug output)
  - Foreword/Prologue kept
  - Introduction chapter added
  - Audio plays correctly

**Known Limitations:**
- No automated integration tests yet
- No CI/CD pipeline
- Manual verification required
- Limited EPUB format coverage
